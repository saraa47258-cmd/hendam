# نظام التحديث التلقائي لمحلات الخياطة

## نظرة عامة
تم تحسين التطبيق لجلب وتحديث قائمة محلات الخياطة تلقائياً عند إضافة محلات جديدة في Firebase.

## التحسينات المنفذة

### 1. تحديث تلقائي محسّن من Firebase
- استخدام `StreamBuilder` مع `snapshots(includeMetadataChanges: true)` للحصول على التحديثات الفورية
- ترتيب المحلات حسب `updatedAt` و `createdAt` لضمان ظهور الأحدث أولاً
- تفعيل التخزين المؤقت للأداء الأفضل

### 2. التحديث اليدوي (Pull to Refresh)
- إضافة `RefreshIndicator` للسماح للمستخدم بتحديث القائمة يدوياً
- زر تحديث في شريط الفلاتر مع مؤشر التحميل
- رسائل نجاح/فشل واضحة للمستخدم

### 3. معالجة محسّنة للأخطاء
- معالجة ذكية لحالات الاتصال المختلفة
- زر "إعادة المحاولة" عند حدوث أخطاء
- زر "تحديث القائمة" عند عدم وجود بيانات

### 4. تحسين الأداء
- دالة `FirebaseService.getTailorsQuery()` موحدة للاستعلامات
- دالة `FirebaseService.refreshData()` للتحقق من الاتصال
- تفعيل الشبكة تلقائياً عند التحديث

## الملفات المحدثة

### 1. `lib/core/services/firebase_service.dart`
```dart
// دالة تحديث البيانات يدوياً
static Future<void> refreshData() async {
  await _firestore?.enableNetwork();
}

// الحصول على استعلام محسّن للخياطين
static Query<Map<String, dynamic>> getTailorsQuery({int? limit}) {
  var query = firestore
      .collection('tailors')
      .orderBy('updatedAt', descending: true)
      .orderBy('createdAt', descending: true);
  
  if (limit != null) {
    query = query.limit(limit);
  }
  
  return query;
}
```

### 2. `lib/features/catalog/presentation/men_services_screen.dart`
- تحويل من `StatelessWidget` إلى `StatefulWidget`
- إضافة `RefreshIndicator` للتحديث اليدوي
- إضافة دالة `_refreshTailors()` للتحديث
- زر تحديث في شريط الفلاتر
- معالجة محسّنة للأخطاء والحالات الفارغة

### 3. `lib/features/tailors/widgets/tailor_card.dart`
- نفس التحسينات المطبقة على `men_services_screen.dart`
- تحديد الحد الأقصى 50 محل في الاستعلام

## كيفية الاستخدام

### التحديث التلقائي
عند إضافة محل جديد في Firebase:
1. سيتم اكتشافه تلقائياً بواسطة `StreamBuilder`
2. ستتحدث القائمة فوراً دون الحاجة لإعادة تشغيل التطبيق
3. سيظهر المحل الجديد في أعلى القائمة

### التحديث اليدوي
للمستخدم خيارات متعددة للتحديث:
1. **السحب للأسفل (Pull to Refresh)**: اسحب القائمة للأسفل
2. **زر التحديث**: انقر على زر "تحديث" في شريط الفلاتر
3. **إعادة المحاولة**: انقر على "إعادة المحاولة" عند حدوث خطأ

## متطلبات Firebase

### هيكل البيانات المطلوب
يجب أن يحتوي كل محل في مجموعة `tailors` على الحقول التالية:
```json
{
  "ownerName": "اسم المالك",
  "profile": {
    "avatar": "رابط الصورة"
  },
  "services": {
    "shopName": "اسم المحل",
    "specialization": "التخصص",
    "totalOrders": 0
  },
  "location": {
    "city": "المدينة",
    "address": "العنوان"
  },
  "rating": 0.0,
  "createdAt": "timestamp",
  "updatedAt": "timestamp"
}
```

### الفهارس المطلوبة (Indexes)
يجب إنشاء فهرس مركب في Firebase:
- Collection: `tailors`
- Fields: `updatedAt` (Descending), `createdAt` (Descending)

## الاختبار

### اختبار التحديث التلقائي
1. افتح التطبيق على صفحة "الخياطة الرجالية"
2. من Firebase Console، أضف محل جديد
3. تحقق من ظهور المحل فوراً في التطبيق

### اختبار التحديث اليدوي
1. اسحب القائمة للأسفل
2. تحقق من ظهور مؤشر التحميل
3. تحقق من ظهور رسالة النجاح

### اختبار معالجة الأخطاء
1. افصل الاتصال بالإنترنت
2. حاول التحديث
3. تحقق من ظهور رسالة الخطأ وزر "إعادة المحاولة"

## الأداء

### التحسينات
- استخدام `includeMetadataChanges: true` للحصول على تحديثات فورية
- التخزين المؤقت المحلي لتحسين السرعة
- تحميل محدود (50 محل) في الشاشة الرئيسية
- إعادة استخدام الاستعلامات عبر `getTailorsQuery()`

### استهلاك البيانات
- التحديثات تستخدم فقط البيانات المتغيرة
- التخزين المؤقت يقلل من طلبات الشبكة
- الاستعلامات محسّنة لجلب البيانات الضرورية فقط

## الملاحظات
- يتم تحديث القائمة تلقائياً عند إضافة أو تعديل أو حذف محلات
- التطبيق يعمل بشكل صحيح حتى بدون اتصال (باستخدام البيانات المخزنة)
- جميع التحديثات تحدث في الوقت الفعلي بدون الحاجة لإعادة تشغيل التطبيق




